<!DOCTYPE html>
<html>
  <head>
    <title>Instana Trace Visualizer</title>
    <script src="js/vis-timeline-graph2d.min.js"></script>
    <script src="js/dot-object.min.js"></script>
    <style>
      body, html {
        font-family: sans-serif;
      }
      div#spandata {
        background: #f8f8f8;
        border: 1px solid #ddd;
        border-left: 3px solid #ffc200;
        color: #282828;
        page-break-inside: avoid;
        font-family: monospace;
        font-size: 12px;
        line-height: 1.6;
        margin-bottom: 1.6em;
        max-width: 100%;
        overflow: auto;
        padding: 1em 1.5em;
        display: block;
        word-wrap: break-word;
      }
      .vis-item.parent {
        border-color: green;
        background-color: lightgreen;
      }
    </style>
  </head>
  <body>
    <p>Upload Instana trace file (.json): <input type="file" id="fileselector"></input></p>
    <p>Trace:<br><div id="timeline"></div></p>
    <p>Span data:<br><div id="spandata"></div></p>
    <script>
      function createDataSetForSpan(span, level, items, groups, parents) {
        // create group for current level
        if (groups.get(level) == null) {
          groups.add({
            id: level,
            content: level
          });
        }

        // store parent information
        if (span.parentId != "") {
          parents[span.id] = span.parentId;
        }

        // format properties in dotted notation
        let data = DotObject.dot(span.data);
        data["id"] = span.id;
        data["name"] = span.name;
        data["label"] = span.label;
        data["duration"] = span.duration + "ms";
        data["duration_self"] = span.calculatedSelfTime + "ms";
        data["parentid"] = span.parentId;

        items.add({
          id: span.id,
          group: level,
          content: `${span.label} (${span.name})`,
          title: JSON.stringify(data, null, 2).replace(/\n/g, "<br>"),
          start: span.start,
          end: span.start+span.duration
        });
        for (let childSpan of span.childSpans) {
          createDataSetForSpan(childSpan, level+1, items, groups, parents);
        }
      }

      function createDataSet(trace) {
        let items = new vis.DataSet();
        let groups = new vis.DataSet();
        let parents = {};

        createDataSetForSpan(trace.rootSpan, 0, items, groups, parents);

        return {items, groups, parents};
      }

      function getParents(spanid, dataset) {
        let result = [];
        for (;;) {
          if (spanid in dataset.parents) {
            let parentid = dataset.parents[spanid];
            result.push(dataset.items.get(parentid));
            spanid = parentid;
          } else {
            break;
          }
        }
        return result;
      }

      var timeline;
      var dataset;

      const timelineContainer = document.getElementById("timeline");
      const fileSelector = document.getElementById("fileselector");
      const spanData = document.getElementById("spandata");

      // timeline element clicked
      timelineContainer.addEventListener("click", (event) => {
        let props = timeline.getEventProperties(event)

        // remove all parent highlights
        dataset.items.forEach((item) => {
          dataset.items.updateOnly({id: item.id, className: null});
        });

        if (props.item != null) {
          // display span data
          let item = dataset.items.get(props.item);
          spanData.innerHTML = item.title;

          // highlight parents
          let parents = getParents(item.id, dataset);
          for (let parent of parents) {
            dataset.items.updateOnly({id: parent.id, className: "parent"});
          }
        } else {
          spanData.innerHTML = "";
        }
      });

      // file uploaded
      fileSelector.addEventListener("change", (event) => {
        const reader = new FileReader();
        reader.addEventListener("load", (event) => {
          let dataJson = JSON.parse(event.target.result);
          dataset = createDataSet(dataJson);
          timeline = new vis.Timeline(timelineContainer, dataset.items, { "orientation": "top" });
          timeline.setGroups(dataset.groups);
        });
        reader.readAsText(event.target.files[0])
      });
    </script>
  </body>
</html>
